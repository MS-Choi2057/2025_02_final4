<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í™©ê¸ˆ íŒŒì¸ì• í”Œ êµë‹¨</title>
    <style>
        /* --- ê¸°ë³¸ ì„¤ì • --- */
        @font-face {
            font-family: 'SF_HambakSnow';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2106@1.1/SF_HambakSnow.woff') format('woff');
            font-weight: normal; font-style: normal;
        }

        /* ìŠ¤í¬ë¡¤ ë° í„°ì¹˜ ë™ì‘ ì œì–´ */
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0; 
            overflow: hidden !important; 
            overscroll-behavior: none; 
            touch-action: none; 
        }

        body {
            background-color: #050505; color: #eee; font-family: 'SF_HambakSnow', serif;
            background-position: center center; background-size: cover; background-attachment: fixed; background-repeat: no-repeat; 
            display: flex; justify-content: center; align-items: center; text-align: center; position: relative; user-select: none;
        }

        body.back-1 { background-image: url('back1.png'); filter: contrast(1.1) saturate(1.2); }
        body.back-oven { background-image: url('oven-bg.jpg'); filter: contrast(1.2) sepia(0.3); } 
        body.back-2 { background-image: url('back2.png'); filter: hue-rotate(-10deg) contrast(1.1); }

        /* ë…¸ì´ì¦ˆ íš¨ê³¼ */
        .screen-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%; z-index: 9000; pointer-events: none;
        }
        .noise-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://cdnjs.cloudflare.com/ajax/libs/paper-css/0.3.0/examples/assets/images/noise.png'); 
            opacity: 0.05; z-index: 9001; pointer-events: none; animation: noise 0.2s infinite;
        }
        @keyframes noise { 0%, 100% { background-position: 0 0; } 50% { background-position: -25% 10%; } }

        /* ìŠ¤í…Œì´ì§€ */
        .stage {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; padding: 0; margin: 0;
            /* [ìˆ˜ì •] ë°°ê²½ í•„í„° ì€ì€í•˜ê²Œ ì¡°ì ˆ (ì™„ì „ ì œê±° X, ì ë‹¹í•œ ì–´ë‘ì›€ O) */
            background: radial-gradient(circle at center, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0.5) 100%);
            z-index: 2; flex-direction: column; justify-content: center; align-items: center;
        }
        .stage.active { display: flex; animation: fadeIn 1s; }
        .stage.vn-stage { justify-content: flex-end; }
        
        /* [ìˆ˜ì •] ì¸í„°ë£¨ë“œ(ëŒ€í™”) ì¥ë©´ë„ ì€ì€í•˜ê²Œ */
        #interlude-stage { z-index: 200; background: rgba(0, 0, 0, 0.4); }

        /* ì„±ì°¬ì‹ ë‹¨ê³„ ë°°ê²½ ì„¤ì • */
        #stage-ritual { background-image: url('back2.png'); background-size: cover; background-position: center; cursor: pointer; position: relative; min-height: 100vh; }
        #stage-ritual::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.2); z-index: 1; pointer-events: none; }
        
        /* GIF ë ˆì´ì–´ */
        #ritual-hand-gif {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; 
            z-index: 5; 
            opacity: 0.8; 
            pointer-events: none;
        }
        #stage-ritual > h2, #stage-ritual > p, #final-pizza { z-index: 10; position: relative; }

        /* íƒ€ì´í¬ê·¸ë˜í”¼ */
        h1 { 
            color: #ff9de2; font-weight: 400; text-shadow: 2px 2px 0px #00ff00;
            margin-bottom: 10px; margin-top: 60px; font-size: 3em; letter-spacing: -2px;
        }
        h2 { 
            color: #ccff00; font-size: 1.5em; margin-top: 0; margin-bottom: 40px; 
            text-shadow: 0 0 5px rgba(0,0,0,0.8); z-index: 10; position: relative; 
            font-family: 'SF_HambakSnow';
        }
        #game-title { position: absolute; top: 100px; left: 0; width: 100%; margin: 0; text-align: center; pointer-events: none; }
        #stage-2 h2, #stage-dough h2, #stage-topping h2 { margin-top: 80px; }
        p { font-size: 1.2em; line-height: 1.6; color: #eee; max-width: 800px; text-shadow: 1px 1px 2px black; }

        /* ê¸€ë¦¬ì¹˜ íš¨ê³¼ */
        .glitch { position: relative; }
        .glitch::before, .glitch::after { content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .glitch::before { left: 2px; text-shadow: -1px 0 #ff00c1; clip: rect(44px, 450px, 56px, 0); animation: glitch-anim 5s infinite linear alternate-reverse; }
        .glitch::after { left: -2px; text-shadow: -1px 0 #00fff9; clip: rect(44px, 450px, 56px, 0); animation: glitch-anim2 5s infinite linear alternate-reverse; }
        @keyframes glitch-anim { 0% { clip: rect(10px, 9999px, 30px, 0); } 100% { clip: rect(70px, 9999px, 80px, 0); } }
        @keyframes glitch-anim2 { 0% { clip: rect(60px, 9999px, 10px, 0); } 100% { clip: rect(20px, 9999px, 50px, 0); } }

        /* ë²„íŠ¼ */
        .next-btn, button { 
            background-color: #000; color: #fff; border: 2px solid #fff; border-radius: 0;
            padding: 15px 30px; font-size: 1.2em; font-family: 'SF_HambakSnow'; cursor: pointer; margin-top: 40px; 
            box-shadow: 5px 5px 0px #ff00de; transition: all 0.1s;
        }
        button:hover:not(:disabled) { transform: translate(-2px, -2px); box-shadow: 7px 7px 0px #00ff00; background: #fff; color: #000; }
        button:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0px #00ff00; }
        button:disabled { background-color: #333; color: #555; border-color: #555; box-shadow: none; cursor: not-allowed; }

        /* ìºë¦­í„° */
        #vn-layer, .vn-layer-common { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .vn-char-container {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center; 
            gap: 50px;
            z-index: 11;
            pointer-events: none;
        }
        .vn-char {
            height: 70vh; width: auto; max-width: 45vw; object-fit: contain; 
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.8));
            transition: all 0.3s ease-out; animation: charFadeIn 1s ease-out;
        }
        .flying-character { position: absolute; width: 150px; height: auto; animation: fly 25s linear infinite; z-index: 5; pointer-events: none; filter: hue-rotate(180deg) invert(0.1); }
        @keyframes fly { 0% { transform: translateX(0) scaleX(1); opacity: 0; } 50% { transform: translateX(120vw) scaleX(-1); opacity: 0; } 100% { transform: translateX(0) scaleX(-1); opacity: 0; } }
        @keyframes charFadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* ëŒ€í™”ì°½ */
        #vn-dialogue-box, .vn-dialogue-box-common {
            position: absolute; bottom: 30px; left: 50% !important; transform: translateX(-50%) !important;
            width: 90%; max-width: 800px; min-height: 150px; background-color: rgba(0, 0, 0, 0.8);
            border: 2px dashed #fff; border-radius: 20px; padding: 30px; box-sizing: border-box; z-index: 20; pointer-events: auto;
        }
        #vn-name-tag, .vn-name-tag-common { position: absolute; top: -15px; left: 20px; background-color: #fff; color: #000; padding: 5px 15px; border-radius: 15px; font-weight: bold; border: 1px solid #000; }
        #vn-text, .vn-text-common { color: #fff; font-size: 1.4em; line-height: 1.6; margin: 0; text-align: left; white-space: pre-wrap; }
        .next-indicator, .next-indicator-common { position: absolute; bottom: 10px; right: 20px; color: #ff00de; font-size: 1.2em; animation: blink 0.5s infinite; display: none; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* ìš°ìƒ ë¶„ì„ ìƒíƒœì°½ ìŠ¤íƒ€ì¼ */
        #idol-status-window {
            position: fixed; 
            width: 320px;
            background-color: rgba(0, 0, 0, 0.95);
            border: 2px solid #fff;
            box-shadow: 5px 5px 0px #ff00de; 
            z-index: 10000;
            padding: 15px;
            text-align: left;
            pointer-events: none; 
            display: none;
            font-family: 'SF_HambakSnow', sans-serif;
        }
        .status-header {
            border-bottom: 2px dashed #555;
            padding-bottom: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-name {
            color: #ccff00;
            font-size: 1.4em;
            font-weight: bold;
        }
        .status-danger {
            color: #ff00de;
            font-size: 0.9em;
            animation: blink 1s infinite;
        }
        .status-body p {
            color: #ddd;
            font-size: 1em;
            line-height: 1.4;
            margin: 5px 0 15px 0;
            text-shadow: none;
        }
        .status-stat-row {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .stat-label { width: 70px; color: #aaa; }
        .stat-bar-bg {
            flex-grow: 1;
            height: 10px;
            background: #333;
            border: 1px solid #555;
        }
        .stat-bar-fill {
            height: 100%;
            background: #ff0000;
            width: 0%;
            transition: width 0.3s;
        }

        /* 1ë‹¨ê³„ */
        .idol-container { display: flex; justify-content: space-around; margin-top: 40px; gap: 20px; }
        .idol-wrapper { position: relative; width: 180px; height: 180px; cursor: pointer; transition: transform 0.2s; }
        .idol-wrapper:hover { transform: scale(1.05) rotate(5deg); }
        .idol-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid #fff; box-shadow: 0 0 15px rgba(255,0,222,0.5); }
        .idol-crack { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.5) 10px, rgba(255,255,255,0.5) 20px); opacity: 0; pointer-events: none; }
        .idol-wrapper.destroyed { animation: shatter 0.6s forwards; pointer-events: none; }
        .idol-wrapper.destroyed .idol-crack { opacity: 1; }
        @keyframes shatter { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.5) rotate(20deg); opacity: 0; filter: blur(10px); } }

        /* 1.5ë‹¨ê³„ */
        .rhythm-container { position: relative; width: 300px; height: 400px; margin: 20px auto; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; gap: 20px; }
        #key-display { width: 160px; height: auto; z-index: 20; margin-bottom: 20px; filter: drop-shadow(0 0 10px #fff); transition: transform 0.2s; }
        #dough-visual { width: 200px; height: 200px; background-color: #ffeaa7; border-radius: 50%; box-shadow: inset -5px -5px 0px rgba(0,0,0,0.1); border: 3px solid #fff; position: relative; transition: transform 0.1s; }
        .dough-squish { animation: squish 0.15s ease-out; }
        @keyframes squish { 0% { transform: scale(1, 1); } 50% { transform: scale(1.3, 0.7); } 100% { transform: scale(1, 1); } }
        .dough-shake { animation: shakeError 0.3s; background-color: #ff7675 !important; }
        @keyframes shakeError { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        .progress-wrapper { width: 300px; margin-top: 20px; }
        .progress-bar-bg { width: 100%; height: 20px; background: #000; border: 2px solid #fff; }
        .progress-bar-fill { width: 0%; height: 100%; background: repeating-linear-gradient(45deg, #ff00de, #ff00de 10px, #ff5eeb 10px, #ff5eeb 20px); transition: width 0.2s; }

        /* 1.8ë‹¨ê³„ */
        #sauce-game-area { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: auto; z-index: 5; overflow: hidden; cursor: crosshair; }
        #stage-sauce h2 { position: absolute; top: 130px; left: 0; width: 100%; margin: 0; z-index: 15; pointer-events: none; text-shadow: 0 0 5px #000; }
        
        /* [ìˆ˜ì •] HUDë¥¼ ìƒë‹¨ì´ ì•„ë‹Œ ê²Œì´ì§€ ê·¼ì²˜ë¡œ ì´ë™í•˜ê¸° ìœ„í•´ ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì œê±° */
        .hud-top { position: absolute; top: auto; bottom: 240px; width: 100%; text-align: center; z-index: 20; pointer-events: none; }
        
        #sauce-progress-container {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 120px; height: 200px;
            background-color: rgba(0, 0, 0, 0.5);
            border: 3px solid #fff;
            border-radius: 10px;
            overflow: hidden;
            z-index: 20;
        }
        #sauce-progress-fill {
            position: absolute; bottom: 0; left: 0;
            width: 100%; height: 0%;
            background: #c0392b;
            transition: height 0.3s ease-out;
        }

        .tomato { position: absolute; width: 90px; height: 90px; background: #ff6b6b; border-radius: 50%; border: 2px solid #000; box-shadow: 5px 5px 0px rgba(0,0,0,0.5); z-index: 5; }
        .tomato::after { content: ''; position: absolute; top: -5px; left: 50%; transform: translateX(-50%); width: 20px; height: 10px; background: #55efc4; border: 1px solid #000; z-index: 2; }
        .slash-trail { position: absolute; width: 10px; height: 10px; background-color: #fff; box-shadow: 0 0 5px #fff, 0 0 10px #ff00de; border-radius: 50%; pointer-events: none; z-index: 50; transform: translate(-50%, -50%); animation: fadeTrail 0.3s linear forwards; }
        @keyframes fadeTrail { 0% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.2); } }
        .tomato-slice-left { position: absolute; width: 45px; height: 90px; background: #b33939; border-radius: 90px 0 0 90px; left: 0; top: 0; animation: sliceLeft 0.8s ease-out forwards; border: 2px solid #000; }
        .tomato-slice-right { position: absolute; width: 45px; height: 90px; background: #b33939; border-radius: 0 90px 90px 0; right: 0; top: 0; animation: sliceRight 0.8s ease-out forwards; border: 2px solid #000; }
        @keyframes sliceLeft { 0% { transform: translate(0, 0) rotate(0); opacity: 1; } 100% { transform: translate(-50px, 100px) rotate(-45deg); opacity: 0; } }
        @keyframes sliceRight { 0% { transform: translate(0, 0) rotate(0); opacity: 1; } 100% { transform: translate(50px, 100px) rotate(45deg); opacity: 0; } }
        .splat-effect { position: absolute; width: 150px; height: 150px; background: radial-gradient(circle, rgba(192, 57, 43, 0.8) 0%, transparent 70%); transform: translate(-50%, -50%); pointer-events: none; animation: fadeOut 0.5s forwards; }
        @keyframes fadeOut { from { opacity: 1; transform: translate(-50%, -50%) scale(1); } to { opacity: 0; transform: translate(-50%, -50%) scale(1.5); } }

        /* 2, 3, íŒŒì¸ì• í”Œ ë‹¨ê³„ */
        #time-bar-container { position: absolute; top: 0; left: 0; width: 100%; height: 15px; background-color: rgba(0,0,0,0.5); z-index: 500; display: none; border-bottom: 2px solid #fff; }
        #time-bar { width: 100%; height: 100%; background-color: #fdcb6e; transition: width 0.1s linear; }
        
        /* [ìˆ˜ì •] ì†ŒìŠ¤ ë‹¨ê³„ìš© íƒ€ì´ë¨¸/ì ìˆ˜ ìŠ¤íƒ€ì¼ (ê²Œì´ì§€ ìœ„) */
        .sauce-info-text {
            font-size: 2rem;
            color: #fdcb6e;
            font-weight: bold;
            text-shadow: 2px 2px 0 #000;
            display: block;
            margin-bottom: 5px;
        }

        /* [ìˆ˜ì •] ë””íœìŠ¤ ë‹¨ê³„ íƒ€ì´ë¨¸ (ìƒë‹¨ ê³ ì •) */
        .timer-display {
            position: fixed !important;
            top: 30px !important; 
            left: 50% !important;
            transform: translateX(-50%) !important;
            font-size: 3rem;
            color: #fdcb6e;
            font-weight: bold;
            text-shadow: 2px 2px 0 #000;
            z-index: 10;
            display: block !important;
        }

        .oven-visual {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 400px;
            margin-bottom: 30px;
            position: relative;
            z-index: 5;
        }
        
        .common-pizza-frame {
            width: 500px; height: 500px; 
            max-width: 90vw; max-height: 55vh; 
            aspect-ratio: 1/1; 
            position: relative; margin: 0 auto;
            display: flex; justify-content: center; align-items: center;
            /* [ìˆ˜ì •] ë°°ê²½ìƒ‰ ì œê±° (íˆ¬ëª…í•˜ê²Œ) */
            /* background-color: rgba(0,0,0,0.5);  <- ì œê±°ë¨ */
            overflow: hidden;}

        .common-pizza-img {
            width: 100%; height: 100%; 
            object-fit: cover; 
            display: block;
        }
        
        .final-pizza-container { cursor: pointer; z-index: 10; }

        .fire-overlay { position: absolute; top: -50px; left: -50px; right: -50px; bottom: -50px; background: radial-gradient(circle, rgba(255, 71, 87, 0.8) 0%, rgba(255,0,0,0) 70%); opacity: 0; pointer-events: none; mix-blend-mode: hard-light; transition: opacity 0.1s; }
        .thermometer-container { width: 80%; max-width: 600px; height: 30px; background: #000; border: 2px solid #fff; border-radius: 5px; overflow: hidden; margin-bottom: 10px; }
        .thermometer-bar { width: 0%; height: 100%; background: linear-gradient(to right, #ffeaa7, #ff7675); transition: width 0.1s linear; }
        .temp-text { font-size: 1.5em; color: #fff; font-weight: bold; text-shadow: 0 0 10px #e67e22; }
        .shake-hard { animation: shakeHard 0.2s; }
        @keyframes shakeHard { 0% { transform: translate(0, 0) rotate(0deg); } 25% { transform: translate(-5px, 5px) rotate(-5deg); } 50% { transform: translate(5px, -5px) rotate(5deg); } 75% { transform: translate(-5px, -5px) rotate(-5deg); } 100% { transform: translate(0, 0) rotate(0deg); } }
        .game-area {
            width: 100vw; height: 100vh;
            max-width: 600px; max-height: 700px;
            margin: 0 auto;
            display: flex; justify-content: center; align-items: center;
        }
        
        .target-zone { position: absolute; width: 50px; height: 50px; border: 2px dashed #fff; border-radius: 50%; transform: translate(-50%, -50%); animation: pulse 1s infinite; z-index: 5; }
        @keyframes pulse { 0% { transform: translate(-50%, -50%) scale(1); opacity: 0.5; } 50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.5; } }
        .t1 { top: 25%; left: 50%; } .t2 { top: 45%; left: 75%; } .t3 { top: 75%; left: 65%; } .t4 { top: 75%; left: 35%; } .t5 { top: 45%; left: 25%; }
        .ingredient-dock { position: absolute; bottom: 50px; padding: 20px; background: rgba(0,0,0,0.7); border: 2px solid #fff; border-radius: 20px; display: flex; justify-content: center; gap: 20px; transition: opacity 0.5s; z-index: 20; }
        .pineapple { width: 60px; height: 60px; border-radius: 50%; background-image: url('pineappleslice.png'); background-size: cover; border: 2px solid #fff; cursor: grab; }
        .placed-pineapple { position: absolute; width: 60px; height: 60px; border-radius: 50%; background-image: url('pineappleslice.png'); background-size: cover; transform: translate(-50%, -50%); z-index: 15; animation: pop 0.3s ease-out; }
        @keyframes pop { 0% { transform: translate(-50%, -50%) scale(0); } 80% { transform: translate(-50%, -50%) scale(1.2); } 100% { transform: translate(-50%, -50%) scale(1); } }
        .mint-choco { position: fixed; width: 180px; height: 180px; background-image: url('mintchoco.png'); background-size: contain; background-repeat: no-repeat; z-index: 100; pointer-events: none; }
        .cursor-shield { position: fixed; width: 100px; height: 100px; border: 3px solid #fff; background: radial-gradient(circle, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0) 70%); border-radius: 50%; pointer-events: none; transform: translate(-50%, -50%); z-index: 200; display: none; mix-blend-mode: screen; box-shadow: 0 0 20px rgba(255,215,0,0.4); }

        .bitten { clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%, 0% 50%, 40% 40%, 50% 50%, 40% 60%, 0% 50%); animation: biteShake 0.2s ease-in-out; }
        @keyframes biteShake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } 100% { transform: translateX(0); } }
        .blink-text { margin-top: 30px; color: #fff; font-size: 1.5em; text-shadow: 0 0 10px #ff00de; animation: blink 1s infinite; z-index: 20; position: relative; }
        #white-flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; pointer-events: none; opacity: 0; transition: opacity 2s ease-in; }
        .flash-active { opacity: 1 !important; }

        /* ì—”ë”© */
        .end-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 300; opacity: 0; pointer-events: none; transition: opacity 1s; }
        .end-screen.active { opacity: 1; pointer-events: auto; }
        #game-over { background: rgba(62, 180, 137, 0.95); }
        #victory-screen { 
            background: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.7)), url('back2.png');
            background-size: cover; background-position: center; color: #ff9de2; 
        }
        #victory-screen::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            box-shadow: inset 0 0 100px rgba(255, 0, 222, 0.3); z-index: -1; pointer-events: none;
            animation: glowPulse 4s infinite alternate;
        }
        @keyframes glowPulse { from { opacity: 0.6; } to { opacity: 1; } }
        /* ìƒ¤ë°©ìƒ¤ë°© íš¨ê³¼ */
        .sparkle { position: absolute; width: 8px; height: 8px; background: white; border-radius: 50%; box-shadow: 0 0 10px #fff, 0 0 20px #ff00de; opacity: 0; animation: twinkle 2s infinite ease-in-out; pointer-events: none; }
        @keyframes twinkle { 0%, 100% { opacity: 0; transform: scale(0.5); } 50% { opacity: 1; transform: scale(1.5); } }
        .action-buttons { display: flex; gap: 15px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        #btn-download, #btn-share { margin-top: 10px; background-color: #FFD700; color: #111; border: none; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }
        .secondary-btn { background-color: transparent !important; border: 2px solid #555 !important; color: #aaa !important; padding: 10px 20px !important; font-size: 0.9em !important; margin-top: 30px !important; }
        .secondary-btn:hover { border-color: #fff !important; color: #fff !important; background-color: rgba(255,255,255,0.1) !important; transform: scale(1.0) !important; box-shadow: none !important; }
        #pizza-transition { position: fixed; top: 50%; left: -50%; transform: translate(-50%, -50%); width: 300px; height: 300px; max-width: 80vw; max-height: 80vw; z-index: 1000; pointer-events: none; display: none; opacity: 0; }
        #pizza-transition img { width: 100%; height: 100%; object-fit: contain; }
        @keyframes slideInPizza { 0% { left: -50%; transform: translate(-50%, -50%) scale(0.5) rotate(-20deg); opacity: 0; } 20% { opacity: 1; } 100% { left: 50%; transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 1; } }
        .slide-in { display: block !important; animation: slideInPizza 1.2s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
    </style>
</head>
<body>
    <audio id="bgm" loop>
        <source src="Risen - Density & Time.mp3" type="audio/mpeg">
    </audio>

    <audio id="sfx-shatter">
        <source src="Wine Glass Shatter.mp3" type="audio/mpeg">
    </audio>

    <audio id="sfx-knead">
        <source src="Wet Shoes Walking Series.mp3" type="audio/mpeg">
    </audio>

    <audio id="sfx-bat">
        <source src="Wooden Bat Hits Baseball Run.mp3" type="audio/mpeg">
    </audio>

    <audio id="bgm-bonfire" loop>
        <source src="Daytime Forrest Bonfire.mp3" type="audio/mpeg">
    </audio>

    <div class="screen-overlay"></div>
    <div class="noise-overlay"></div>

    <div id="idol-status-window">
        <div class="status-header">
            <span class="status-name" id="status-name-text">NAME</span>
            <span class="status-danger">ì´ë‹¨ ê²½ê³ </span>
        </div>
        <div class="status-body">
            <p id="status-desc-text">Description goes here.</p>
            <div class="status-stat-row">
                <span class="stat-label">ë¶ˆìˆœë„</span>
                <div class="stat-bar-bg"><div class="stat-bar-fill" id="status-impurity-bar" style="width: 0%"></div></div>
            </div>
            <div class="status-stat-row">
                <span class="stat-label">ë‹¹ë„</span>
                <div class="stat-bar-bg"><div class="stat-bar-fill" style="width: 0%"></div></div>
            </div>
        </div>
    </div>

    <img src="pizza-angel.png" alt="ì²œì‚¬" class="flying-character">
    <img src="pizza-angel.png" alt="ì²œì‚¬" class="flying-character">
    <img src="pizza-angel.png" alt="ì²œì‚¬" class="flying-character">

    <div id="pizza-transition">
        <img src="pizza1.png" alt="í”¼ì">
    </div>

    <div id="cursor-tooltip" style="display: none;"></div>

    <div id="intro" class="stage active">
        <h1 class="glitch" data-text="íŒŒì¸ì• í”Œ í”¼ì êµë‹¨ì„ í–¥í•˜ì—¬">íŒŒì¸ì• í”Œ í”¼ì êµë‹¨ì„ í–¥í•˜ì—¬</h1>
        <h2>ë‹¨ì§ ì˜ ì§„ë¦¬ë¥¼ ì°¾ëŠ” ì—¬ì •</h2>
        <p>ìœ„ëŒ€í•œ ì˜¤ë¸ì˜ ì—´ê¸° ì†ì—ì„œ<br>ê±°ì§“ëœ í¸ê²¬ì„ íƒœìš°ê³  êµ¬ì›ì— ì´ë¥´ì‹­ì‹œì˜¤.</p>
        <button id="btn-start-ritual" class="next-btn">ì…ë‹¨ ì˜ì‹ ì‹œì‘í•˜ê¸°</button>
    </div>

    <div id="interlude-stage" class="stage vn-stage">
        <div class="vn-layer-common">
            <div class="vn-char-container">
                <img src="leader.png" alt="êµì£¼" class="vn-char leader">
                <img src="pizza-angel.png" alt="ì¡°ìˆ˜" class="vn-char guest" style="opacity: 0; display:none;">
            </div>
            <div class="vn-dialogue-box-common">
                <div class="vn-name-tag-common">ğŸ í™©ê¸ˆ í˜€ì˜ êµì£¼</div>
                <p class="vn-text-common"></p>
                <div class="next-indicator-common">â–¼</div>
            </div>
        </div>
    </div>

    <div id="stage-1" class="stage vn-stage">
        <div id="vn-layer">
            <div class="vn-char-container">
                <img src="leader.png" alt="êµì£¼" class="vn-char leader">
            </div>
            <div id="vn-dialogue-box">
                <div id="vn-name-tag">ğŸ í™©ê¸ˆ í˜€ì˜ êµì£¼</div>
                <p id="vn-text"></p>
                <div class="next-indicator">â–¼</div>
            </div>
        </div>

        

        <div id="idol-destruction-interface" style="display: none;">
            <h1 class="glitch" data-text="ì°¸íšŒì˜ ë°©">ì°¸íšŒì˜ ë°©</h1>
            <h2>ê±°ì§“ëœ ì´ë‹¨ì˜ í”¼ìë“¤ì„ ì œê±°í•˜ì„¸ìš”</h2>
            <div class="idol-container">
                <div class="idol-wrapper" id="idol-1" data-name="í˜í¼ë¡œë‹ˆ">
                    <img src="pepperoni.png" alt="í˜í¼ë¡œë‹ˆ" class="idol-img">
                    <div class="idol-crack"></div>
                </div>
                <div class="idol-wrapper" id="idol-2" data-name="ì½¤ë¹„ë„¤ì´ì…˜">
                    <img src="combination.png" alt="ì½¤ë¹„ë„¤ì´ì…˜" class="idol-img">
                    <div class="idol-crack"></div>
                </div>
                <div class="idol-wrapper" id="idol-3" data-name="ì¹˜ì¦ˆ">
                    <img src="cheese.png" alt="ì¹˜ì¦ˆ" class="idol-img">
                    <div class="idol-crack"></div>
                </div>
            </div>
            <p id="idol-feedback" class="feedback"></p>
            <button id="btn-to-next-1" class="next-btn" disabled>ë‹¤ìŒìœ¼ë¡œ</button>
        </div>
    </div>

    <div id="stage-dough" class="stage game-stage">
        <h2>í™”ë©´ì˜ ì§€ì‹œì— ë§ì¶° ë°©í–¥í‚¤ë¥¼ ì…ë ¥í•´<br>ì„±ìŠ¤ëŸ¬ìš´ ë„ìš°ë¥¼ ë°˜ì£½í•˜ì„¸ìš”!</h2>
        <div class="rhythm-container">
            <img id="key-display" src="point.png" alt="ì§€ì‹œ ë°©í–¥" style="display: none;">
            <div id="dough-visual"></div>
        </div>
        <div class="progress-wrapper">
            <div class="progress-bar-bg">
                <div id="dough-progress" class="progress-bar-fill"></div>
            </div>
            <p id="dough-status-text">ë°˜ì£½ ì™„ì„±ë„: 0%</p>
        </div>
    </div>

    <div id="stage-sauce" class="stage game-stage">
        <h2>ë§ˆìš°ìŠ¤ë¥¼ íœ˜ë‘˜ëŸ¬ ë‚ ì•„ì˜¤ëŠ” í† ë§ˆí† ë¥¼ ë² ì–´ë²„ë¦¬ì„¸ìš”!<br>(ëª©í‘œ: 15ê°œ)</h2>
        <div class="hud-top">
            <div id="sauce-timer" class="sauce-info-text">15.00</div>
            <div id="sauce-score" class="sauce-info-text">Score: 0/15</div>
        </div>
        <div id="sauce-game-area"></div>
        <div id="sauce-progress-container">
            <div id="sauce-progress-fill"></div>
        </div>
    </div>

    <div id="stage-topping" class="stage game-stage">
        <h2 id="topping-title">ì„±ìŠ¤ëŸ¬ìš´ íŒŒì¸ì• í”Œ 5ì¡°ê°ì„<br>ì ì„  ìœ„ì— ì•ˆì°©ì‹œí‚¤ì„¸ìš”</h2>
        <div class="game-area">
            <div class="common-pizza-frame" id="topping-pizza-container">
                <img src="pizza1.png" class="common-pizza-img">
                <div class="target-zone t1" data-id="1"></div>
                <div class="target-zone t2" data-id="2"></div>
                <div class="target-zone t3" data-id="3"></div>
                <div class="target-zone t4" data-id="4"></div>
                <div class="target-zone t5" data-id="5"></div>
            </div>
        </div>
        <div class="ingredient-dock" id="dock">
            <div class="pineapple" draggable="true" id="p1"></div>
            <div class="pineapple" draggable="true" id="p2"></div>
            <div class="pineapple" draggable="true" id="p3"></div>
            <div class="pineapple" draggable="true" id="p4"></div>
            <div class="pineapple" draggable="true" id="p5"></div>
        </div>
    </div>

    <div id="stage-2" class="stage game-stage">
        <h2>ìŠ¤í˜ì´ìŠ¤ë°”ë¥¼ ì—°íƒ€í•˜ì—¬<br>ì˜¨ë„ë¥¼ ë†’ì—¬ í”¼ìë¥¼ ì™„ì„±í•˜ì„¸ìš”!</h2>
        <div class="oven-visual">
            <div class="common-pizza-frame" id="oven-pizza-wrapper">
                <img src="pizza1.png" class="common-pizza-img">
                <div class="fire-overlay"></div>
            </div>
        </div>
        <div class="thermometer-container">
            <div class="thermometer-bar" id="temp-bar"></div>
        </div>
        <div class="temp-text">í˜„ì¬ ì˜¨ë„: <span id="temp-display">0</span>â„ƒ / 400â„ƒ</div>
    </div>

    <div id="stage-3" class="stage game-stage">
        <div id="time-bar-container"><div id="time-bar"></div></div>
        
        <h2 id="game-title">ë¯¼íŠ¸ì´ˆì½”ë¡œë¶€í„° 15ì´ˆê°„ í”¼ìë¥¼ ì‚¬ìˆ˜í•˜ì„¸ìš”!</h2>
        
        <div class="timer-display" id="timer">15.00</div>
        
        <div class="game-area">
            <div class="common-pizza-frame">
                <img src="pizza1.png" class="common-pizza-img" id="pizza-defense">
            </div>
        </div>
        <div class="cursor-shield" id="shield"></div>
    </div>

    <div id="stage-ritual" class="stage game-stage">
        <img id="ritual-hand-gif" src="craving_hand.gif" alt="ì†">

        <h2>ì˜ì‹ì´ ëë‚¬ìŠµë‹ˆë‹¤.<br>ì´ì œ ì„±ìŠ¤ëŸ¬ìš´ íŒŒì¸ì• í”Œ í”¼ìë¥¼ ì˜ì ‘í•˜ì‹­ì‹œì˜¤.</h2>
        
        <div class="common-pizza-frame final-pizza-container" id="final-pizza">
            <img src="pizza1.png" alt="ì™„ì„±ëœ í”¼ì" class="common-pizza-img">
        </div>

        <p class="blink-text">í”¼ìë¥¼ í´ë¦­í•˜ì—¬ 'ì§„ë¦¬'ë¥¼ ë§›ë³´ì„¸ìš”</p>
    </div>

    <div class="end-screen" id="game-over">
        <h1>ì‹¤íŒ¨...</h1>
        <p id="fail-reason">ë¯¿ìŒì´ ë¶€ì¡±í•˜ì—¬ í”¼ìê°€ ì™„ì„±ë˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>
        <button id="btn-retry">ë‹¤ì‹œ ë„ì „í•˜ê¸°</button>
    </div>

    <div class="end-screen" id="victory-screen">
        <h1 class="glitch" data-text="ì¶•í•˜í•©ë‹ˆë‹¤!">ì¶•í•˜í•©ë‹ˆë‹¤!</h1>
        <p>ì™„ë²½í•œ í•˜ì™€ì´ì•ˆ í”¼ìë¥¼ ì§€ì¼œëƒˆìŠµë‹ˆë‹¤.</p>
        <div id="rebirth-area">
            <p>ë‹¹ì‹ ì—ê²Œ ìƒˆë¡œìš´ ì´ë¦„ì„ í•˜ì‚¬í•©ë‹ˆë‹¤.</p>
            <h2 id="new-cult-name" style="color:#FFD700; margin:20px 0;">...</h2>
        </div>
        <div class="action-buttons">
            <button id="btn-download">ğŸ• ì„±ìŠ¤ëŸ¬ìš´ í”¼ì ë°›ê¸°</button>
            <button id="btn-share">ğŸ”— êµë‹¨ ë§í¬ ì „íŒŒí•˜ê¸°</button>
        </div>
        <button id="btn-restart-game" class="secondary-btn">ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>

    <div id="white-flash"></div>
    <script>
        // --- ì „ì—­ ë°ì´í„° ---
        const idolData = {
            "í˜í¼ë¡œë‹ˆ": {
                desc: "ì§œê³  ê¸°ë¦„ì§„ ë¶‰ì€ ì›ë°˜. ë‹¨ë§›ì´ë¼ê³¤ ì°¾ì•„ë³¼ ìˆ˜ ì—†ëŠ” ì•¼ë§Œì ì¸ ê³ ê¸° ì¡°ê°.",
                impurity: 85
            },
            "ì½¤ë¹„ë„¤ì´ì…˜": {
                desc: "ì´ë„ ì €ë„ ì•„ë‹Œ í˜¼ë€ì˜ ë©ì–´ë¦¬. ì •ì²´ì„± ì—†ì´ ë’¤ì„ì¸ ì¡íƒ•ì˜ í‘œë³¸.",
                impurity: 92
            },
            "ì¹˜ì¦ˆ": {
                desc: "ëŠë¼í•¨ì˜ ê²°ì •ì²´. ê³¼ì¼ì˜ ìƒí¼í•¨ì„ ê±°ë¶€í•˜ëŠ” ëˆì í•˜ê³  ì˜¤ë§Œí•œ ì§€ë°© ë©ì–´ë¦¬.",
                impurity: 78
            }
        };

        // --- ì „ì—­ ë³€ìˆ˜ ---
        const stages = document.querySelectorAll('.stage');
        let gameLoopId, timerInterval, ovenLoopId, sauceInterval, lastTime;

        // --- ìœ í‹¸ë¦¬í‹° ---
        function showStage(stageId) {
            stages.forEach(stage => stage.classList.remove('active'));
            document.getElementById(stageId).classList.add('active');

            if (stageId === 'stage-2') document.body.className = 'back-oven';
            else if (stageId === 'stage-3') document.body.className = 'back-2';
            else if (stageId === 'stage-ritual') document.body.className = 'back-2'; 
            else document.body.className = 'back-1';
        }

        // --- ì´ˆê¸°í™” ---
        document.addEventListener('DOMContentLoaded', () => initIntro());

        function initIntro() {
            // ìŠ¤í¬ë¡¤ ê°•ì œ ì°¨ë‹¨
            document.body.style.overflow = 'hidden';
            showStage('intro');
           document.getElementById('btn-start-ritual').onclick = () => {
    // BGM ì¬ìƒ ì½”ë“œ ì‹œì‘
    const bgm = document.getElementById('bgm');
    bgm.volume = 0.1; // [ìˆ˜ì •ë¨] BGM ë³¼ë¥¨ì„ 0.3ì—ì„œ 0.1ë¡œ ë‚®ì¶¤ (íš¨ê³¼ìŒì„ ë” ì˜ ë“¤ë¦¬ê²Œ í•˜ê¸° ìœ„í•¨)
    bgm.play().catch(e => console.log("ì¬ìƒ ì‹¤íŒ¨:", e));
    // BGM ì¬ìƒ ì½”ë“œ ë

    showStage('stage-1');
    initStage1(); 
}};

// --- ë¸Œë¦¿ì§€ ëŒ€ì‚¬ ---
        const bridge1Data = [
            "í¬íí... ë“¤ë¦¬ì‹­ë‹ˆê¹Œ? ìœ„ì„ ì˜ ìš°ìƒë“¤ì´ ì‚°ì‚°ì¡°ê° ë‚˜ëŠ” ì†Œë¦¬ê°€...", 
            "ë‹¹ì‹ ì€ ì²« ë²ˆì§¸ ì‹œë ¨ì„ í†µê³¼í–ˆìŠµë‹ˆë‹¤.", 
            "í•˜ì§€ë§Œ ì§„ì •í•œ ì—¬ì •ì€ ì´ì œë¶€í„°ì…ë‹ˆë‹¤.",
            "ìˆ˜ì²œ ë…„ ë™ì•ˆ ì¸ë¥˜ëŠ” ì˜ëª»ëœ í† í•‘ì˜ ë…¸ì˜ˆë¡œ ì‚´ì•„ì™”ìŠµë‹ˆë‹¤.",
            "í˜í¼ë¡œë‹ˆì˜ ê¸°ë¦„ì§„ ê±°ì§“ë§, ì½¤ë¹„ë„¤ì´ì…˜ì˜ í˜¼ë€ìŠ¤ëŸ¬ìš´ ìœ í˜¹...",
            "ì´ì œ ë‹¹ì‹ ì˜ ì†ìœ¼ë¡œ 'ì§„ë¦¬ì˜ ë°˜ì£½'ì„ ë¹šì„ ì‹œê°„ì…ë‹ˆë‹¤.",
            "ì†ê°€ë½ì´ ê°€ë¦¬í‚¤ëŠ” ì„±ìŠ¤ëŸ¬ìš´ ë°©í–¥ì„ ë”°ë¥´ì„¸ìš”.",
            "ê° ì›€ì§ì„ì—ëŠ” ê¹¨ë‹¬ìŒì´ ë‹´ê²¨ ìˆìŠµë‹ˆë‹¤."
        ];
        
        const bridgeSauceData = [
            "...ì™„ë²½í•©ë‹ˆë‹¤.", 
            "ë‹¹ì‹ ì˜ ì†ì—ì„œ ë§Œë“¤ì–´ì§„ ì´ ë°˜ì£½ì—ëŠ”...",
            "ìˆ˜ë°± ëª…ì˜ ì‹ ë„ë“¤ì´ í‰ìƒ ì°¾ì§€ ëª»í•œ 'ê· í˜•'ì´ ê¹ƒë“¤ì–´ ìˆìŠµë‹ˆë‹¤.",
            "í•˜ì§€ë§Œ ë°˜ì£½ë§Œìœ¼ë¡œëŠ” ë¶€ì¡±í•©ë‹ˆë‹¤.",
            "ì „ì„¤ì— ë”°ë¥´ë©´, ìµœì´ˆì˜ íŒŒì¸ì• í”Œ í”¼ìëŠ”...",
            "ìë°œì ìœ¼ë¡œ í—Œì‹ í•œ í† ë§ˆí† ë“¤ì˜ ë¶‰ì€ ëˆˆë¬¼ë¡œ ë§Œë“¤ì–´ì¡Œë‹¤ê³  í•©ë‹ˆë‹¤.",
            "ë‹¹ì‹ ë„ ê·¸ ì˜ì‹ì„ ì¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.",
            "ë–¨ì–´ì§€ëŠ” í† ë§ˆí† ë“¤... ê·¸ë“¤ì€ ë‹¨ìˆœí•œ ì¬ë£Œê°€ ì•„ë‹™ë‹ˆë‹¤.",
            "ê°ìê°€ 'êµ¬ì›ë°›ê³  ì‹¶ë‹¤'ëŠ” ì†Œë§ìœ¼ë¡œ í•˜ëŠ˜ì—ì„œ ë‚´ë ¤ì˜¤ëŠ” ê²ƒì…ë‹ˆë‹¤.",
            "ë‹¹ì‹ ì˜ ì†ìœ¼ë¡œ ê·¸ë“¤ì˜ ì†Œë§ì„ ì´ë£¨ì–´ì£¼ì‹­ì‹œì˜¤."
        ];
        
        const bridgeToppingData = [
            "...ì ì‹œë§Œìš”. ì´ í–¥ê¸°...", 
            "ì œê°€ 50ë…„ê°„ êµë‹¨ì„ ì´ëŒë©´ì„œë„ ë§¡ì•„ë³´ì§€ ëª»í•œ ì™„ë²½í•œ ì†ŒìŠ¤ì˜ í–¥ì…ë‹ˆë‹¤.",
            "ë‹¹ì‹ ì—ê²ŒëŠ”... íŠ¹ë³„í•œ ë¬´ì–¸ê°€ê°€ ìˆêµ°ìš”.",
            "ì–´ì©Œë©´ ì˜ˆì–¸ì—ì„œ ë§í•˜ë˜ 'í™©ê¸ˆ í˜€ì˜ ì„ íƒë°›ì€ ì'ê°€...",
            "í•˜ì§€ë§Œ ì•„ì§ í™•ì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
            "ë§ˆì§€ë§‰ ì‹œí—˜ì´ ë‚¨ì•˜ìŠµë‹ˆë‹¤.",
            "íŒŒì¸ì• í”Œ... ë…¼ìŸì˜ ì¤‘ì‹¬ì— ì„  ê³¼ì¼.",
            "ì–´ë–¤ ì´ë“¤ì€ ì´ë¥¼ 'ì‹ ì„±ëª¨ë…'ì´ë¼ ë¶€ë¥´ê³ ,",
            "ë˜ ë‹¤ë¥¸ ì´ë“¤ì€ 'ê³„ì‹œ'ë¼ê³  ë¶€ë¦…ë‹ˆë‹¤.",
            "ì´ ë‹¤ì„¯ ì¡°ê°ì„ ì •í™•í•œ ìœ„ì¹˜ì— ë†“ìœ¼ì‹­ì‹œì˜¤.",
            "í•œ ì¡°ê°ì´ë¼ë„ ì–´ê¸‹ë‚˜ë©´... ëª¨ë“  ê²ƒì´ ë¬´ë„ˆì§‘ë‹ˆë‹¤."
        ];
        
        const bridgeOvenData = [
            "...ë¯¿ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.", 
            "ì™„ë²½í•œ ì˜¤ê°í˜•ì˜ ê· í˜•...",
            "ì´ê²ƒì€ 1985ë…„, ì°½ì‹œìê°€ ì²˜ìŒ ê³„ì‹œë¥¼ ë°›ì•˜ì„ ë•Œì˜ ë°°ì¹˜ì™€ ì •í™•íˆ ì¼ì¹˜í•©ë‹ˆë‹¤!",
            "ë‹¹ì‹ ì€ ì§„ì§œì…ë‹ˆë‹¤. ì˜ˆì–¸ëœ ê·¸ ì‚¬ëŒ...",
            "í•˜ì§€ë§Œ ì•„ì§ ëì´ ì•„ë‹™ë‹ˆë‹¤.",
            "ê°€ì¥ ìœ„í—˜í•œ ìˆœê°„ì´ ë‹¤ê°€ì˜µë‹ˆë‹¤.",
            "400ë„... ì‹ ê³¼ ì•…ë§ˆê°€ ë§Œë‚˜ëŠ” ì˜¨ë„ì…ë‹ˆë‹¤.",
            "ì´ ë¶ˆê¸¸ ì†ì—ì„œ í”¼ìëŠ” ë‘ ê°€ì§€ ìš´ëª… ì¤‘ í•˜ë‚˜ë¥¼ ë§ì´í•©ë‹ˆë‹¤.",
            "ì˜ì›í•œ ì™„ì„±, í˜¹ì€ ì˜ì›í•œ ì¬ê°€ ë˜ëŠ” ê²ƒ.",
            "ë‹¹ì‹ ì˜ ì‹ ë…ë§Œì´ ê·¸ ê²°ê³¼ë¥¼ ê²°ì •í•©ë‹ˆë‹¤."
        ];
        
        const bridgeDefenseData = [
            "ì˜¤ì˜¤... ì´ í™©ê¸ˆë¹› ê´‘ì±„ë¥¼...", 
            "íŒŒì¸ì• í”Œì´ ì™„ë²½í•˜ê²Œ ìºëŸ¬ë©œí™”ë˜ì—ˆìŠµë‹ˆë‹¤!",
            "ë‹¹ì‹ ì€ í•´ëƒˆìŠµë‹ˆë‹¤. ì „ì„¤ì˜ í”¼ìë¥¼ ì™„ì„±í•œ ê²ƒì…ë‹ˆë‹¤!",
            "ì´ì œ ì˜ì›í•œ êµ¬ì›ì´ ì•½ì†ëœ...",
            "...?!",
            "...ì•ˆ ë©ë‹ˆë‹¤. ì´ ëƒ„ìƒˆëŠ”...",
            "ë¯¼íŠ¸ì´ˆì½”... ì €ì£¼ë°›ì€ ë°˜ëŒ€ êµë‹¨ì˜ ì•…ì·¨!",
            "ê·¸ë“¤ì´ ê°ì§€í–ˆìŠµë‹ˆë‹¤! ì™„ë²½í•œ í”¼ìì˜ íƒ„ìƒì„!",
            "ê·¸ë“¤ì€ ì§ˆíˆ¬í•©ë‹ˆë‹¤. ì¡°í™”ë¥¼ ì´ë£¨ëŠ” ëª¨ë“  ê²ƒì„.",
            "ë¯¼íŠ¸ì™€ ì´ˆì½œë¦¿... ê²°ì½” ë§Œë‚˜ì„œëŠ” ì•ˆ ë  ë‘ ì¡´ì¬ì˜ ê¸ˆë‹¨ì˜ ê²°í•©.",
            "ê·¸ë“¤ì€ ë‹¹ì‹ ì˜ í”¼ìë¥¼ íƒ€ë½ì‹œí‚¤ë ¤ í•©ë‹ˆë‹¤!",
            "15ì´ˆ... ê·¸ë“¤ì˜ ê³µê²©ì´ ëë‚  ë•Œê¹Œì§€",
            "ë‹¹ì‹ ì˜ í”¼ìë¥¼ ì§€ì¼œë‚´ì‹­ì‹œì˜¤!"
        ];
        
        const bridgeRitualData = [
            "...ê¸°ì ì…ë‹ˆë‹¤.", 
            "ë¯¼íŠ¸ì´ˆì½”ì˜ ì €ì£¼ë¥¼ ë¬¼ë¦¬ì³¤ìŠµë‹ˆë‹¤...",
            "50ë…„ êµë‹¨ ì—­ì‚¬ìƒ ì´ëŸ° ì¼ì€ ì²˜ìŒì…ë‹ˆë‹¤.",
            "ë‹¹ì‹  ì•ì— ë†“ì¸ ì´ í”¼ìë¥¼ ë³´ì‹­ì‹œì˜¤.",
            "ì™„ë²½í•œ í™©ê¸ˆë¹› ê°ˆìƒ‰. ë…¹ì•„ë‚´ë¦° ì¹˜ì¦ˆì˜ ì‹¤. ìºëŸ¬ë©œí™”ëœ íŒŒì¸ì• í”Œ.",
            "ì´ê²ƒì€ ë” ì´ìƒ ìŒì‹ì´ ì•„ë‹™ë‹ˆë‹¤.",
            "ì´ê²ƒì€ 'ê³„ì‹œ'ì…ë‹ˆë‹¤.",
            "ìˆ˜ì²œ ëª…ì´ í‰ìƒ ì°¾ì•„ í—¤ë§¤ë„ ë³´ì§€ ëª»í•˜ëŠ” ì§„ë¦¬ì˜ í˜„í˜„(é¡¯ç¾).",
            "ì´ì œ... ë§ˆì§€ë§‰ ì˜ì‹ë§Œì´ ë‚¨ì•˜ìŠµë‹ˆë‹¤.",
            "ì…ì„ ë²Œë¦¬ê³ , ì´ ì§„ë¦¬ë¥¼ ë°›ì•„ë“¤ì´ì‹­ì‹œì˜¤.",
            "í•œ ì…ì„ ë² ì–´ë¬¼ ë•Œ, ë‹¹ì‹ ì€ ë” ì´ìƒ ì˜ˆì „ì˜ ë‹¹ì‹ ì´ ì•„ë‹™ë‹ˆë‹¤.",
            "ë‹¹ì‹ ì€ 'ê¹¨ë‹¬ì€ ì'ê°€ ë©ë‹ˆë‹¤."
        ];

        let interludeIndex = 0, interludeCallback = null, interludeTexts = [], isInterludeTyping = false, interludeTimeout;

        function playInterlude(dialogueArray, nextFunction) {
            interludeTexts = dialogueArray; interludeCallback = nextFunction; interludeIndex = 0;
            const stage = document.getElementById('interlude-stage'); stage.classList.add('active');
            const layer = stage.querySelector('.vn-layer-common'); layer.onclick = null; layer.onclick = handleInterludeClick;
            showNextInterlude();
        }
        function handleInterludeClick() {
            if (isInterludeTyping) { clearTimeout(interludeTimeout); document.querySelector('.vn-text-common').textContent = interludeTexts[interludeIndex - 1]; isInterludeTyping = false; document.querySelector('.next-indicator-common').style.display = 'block'; }
            else showNextInterlude();
        }
        function showNextInterlude() {
            if (interludeIndex < interludeTexts.length) { typeWriterCommon(interludeTexts[interludeIndex]); interludeIndex++; }
            else { document.getElementById('interlude-stage').classList.remove('active'); if (interludeCallback) interludeCallback(); }
        }
        function typeWriterCommon(text) {
            const textEl = document.querySelector('.vn-text-common'); const indicator = document.querySelector('.next-indicator-common');
            textEl.textContent = ''; indicator.style.display = 'none'; isInterludeTyping = true;
            let i = 0; function type() { if (i < text.length) { textEl.textContent += text.charAt(i); i++; interludeTimeout = setTimeout(type, 30); } else { isInterludeTyping = false; indicator.style.display = 'block'; } } type();
        }

        // --- 1ë‹¨ê³„: ì°¸íšŒ ---
        const dialogueData = ["ì–´ì„œ ì˜¤ì‹­ì‹œì˜¤, ê¸¸ì„ ìƒì€ ì–´ë¦° ì–‘ì´ì—¬.", "ê·¸ëŒ€ì˜ í˜€ëŠ”... ê±°ì§“ëœ ë§›ì— ì†ì•„ì™”êµ°ìš”.", "ì´ì œ íŒŒì¸ì• í”Œ í”¼ìë¥¼ í†µí•´ ì§„ì •í•œ ë§›ì˜ ê¸¸ë¡œ ì¸ë„ë  ê²ƒì…ë‹ˆë‹¤.", "ì € ì—­ê²¨ìš´ ìš°ìƒë“¤ì„ ê·¸ëŒ€ì˜ ì†ìœ¼ë¡œ ì§ì ‘ íŒŒê´´í•˜ì‹­ì‹œì˜¤!"];
        let currentDialogueIndex = 0, isTyping = false, typingTimeout;

        function initStage1() {
            document.getElementById('idol-destruction-interface').style.display = 'none';
            document.getElementById('vn-layer').style.display = 'block';
            document.getElementById('stage-1').classList.add('vn-stage');
            startDialogue();
        }
        function startDialogue() {
            currentDialogueIndex = 0; showNextDialogue();
            document.getElementById('vn-layer').onclick = (e) => { if (e.target.id === 'vn-layer' || e.target.closest('#vn-dialogue-box')) { if (isTyping) completeTyping(); else showNextDialogue(); } };
        }
        function showNextDialogue() { if (currentDialogueIndex < dialogueData.length) { typeWriter(dialogueData[currentDialogueIndex]); currentDialogueIndex++; } else endDialogue(); }
        function typeWriter(text) {
            const textEl = document.getElementById('vn-text'); const indicator = document.querySelector('.next-indicator');
            textEl.textContent = ''; indicator.style.display = 'none'; isTyping = true;
            let i = 0; function type() { if (i < text.length) { textEl.textContent += text.charAt(i); i++; typingTimeout = setTimeout(type, 30); } else { isTyping = false; indicator.style.display = 'block'; } } type();
        }
        function completeTyping() { clearTimeout(typingTimeout); document.getElementById('vn-text').textContent = dialogueData[currentDialogueIndex - 1]; isTyping = false; document.querySelector('.next-indicator').style.display = 'block'; }
        function endDialogue() { document.getElementById('vn-layer').style.display = 'none'; document.getElementById('stage-1').classList.remove('vn-stage'); const ui = document.getElementById('idol-destruction-interface'); ui.style.display = 'block'; ui.style.animation = 'fadeIn 1s'; initIdolDestruction(); }

        function initIdolDestruction() {
            const idols = document.querySelectorAll('.idol-wrapper');
            const nextBtn = document.getElementById('btn-to-next-1');
            const statusWindow = document.getElementById('idol-status-window');
            
            if (!statusWindow) return;

            let destroyedCount = 0;

            idols.forEach(idol => {
                const newIdol = idol.cloneNode(true);
                idol.parentNode.replaceChild(newIdol, idol);
                
                const showStatus = () => {
                    if (newIdol.classList.contains('destroyed')) {
                        statusWindow.style.display = 'none';
                        return;
                    }
                    const name = newIdol.dataset.name;
                    const data = idolData[name];
                    
                    if (data) {
                        document.getElementById('status-name-text').innerText = name;
                        document.getElementById('status-desc-text').innerText = data.desc;
                        document.getElementById('status-impurity-bar').style.width = data.impurity + '%';
                        statusWindow.style.display = 'block';
                    }
                };

                newIdol.addEventListener('mouseenter', showStatus);
                
                newIdol.addEventListener('mousemove', (e) => {
                    if (newIdol.classList.contains('destroyed')) return;
                    statusWindow.style.left = (e.clientX + 20) + 'px';
                    statusWindow.style.top = (e.clientY + 20) + 'px';
                });

                newIdol.addEventListener('mouseleave', () => {
                    statusWindow.style.display = 'none';
                });

                newIdol.addEventListener('click', () => {
                    statusWindow.style.display = 'none';
                    if (!newIdol.classList.contains('destroyed')) {
                        // [ìˆ˜ì •ë¨] íš¨ê³¼ìŒ ì¬ìƒ ì½”ë“œ (ì´ì „ ë‹¨ê³„ì—ì„œ ì¶”ê°€ë¨)
                        const shatterSfx = document.getElementById('sfx-shatter');
                        if (shatterSfx) {
                            shatterSfx.currentTime = 0; 
                            shatterSfx.play().catch(e => console.log('Sound error', e));
                        }

                        newIdol.classList.add('destroyed');
                        destroyedCount++;
                        document.getElementById('idol-feedback').textContent = `'${newIdol.dataset.name}' íŒŒê´´ë¨.`;
                        if (destroyedCount === idols.length) nextBtn.disabled = false;
                    }
                });
            });
            
            nextBtn.onclick = () => { 
                playInterlude(bridge1Data, () => { 
                    showStage('stage-dough'); 
                    initStageDough(); 
                }); 
            };
        }

        // --- 1.5ë‹¨ê³„: ë„ìš° ë°˜ì£½ ---
        let doughScore = 0; const DOUGH_GOAL = 10; let currentKey = '';
        const keys = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'];
        const keyRotations = { 'ArrowUp': '0deg', 'ArrowDown': '180deg', 'ArrowLeft': '-90deg', 'ArrowRight': '90deg' };

        function initStageDough() {
            doughScore = 0; updateDoughUI(); setNewDoughKey();
            window.addEventListener('keydown', handleDoughKey);
        }
        function setNewDoughKey() {
            currentKey = keys[Math.floor(Math.random() * keys.length)];
            const display = document.getElementById('key-display');
            display.style.display = 'block'; display.style.transform = `rotate(${keyRotations[currentKey]})`;
            display.style.animation = 'none'; display.offsetHeight; display.style.animation = 'pulseKey 0.5s infinite alternate';
        }
        function handleDoughKey(e) {
            const dough = document.getElementById('dough-visual');
            if (e.code === currentKey) {
                // [ì¶”ê°€ëœ ë¶€ë¶„] ë°˜ì£½ ì†Œë¦¬ ì¬ìƒ (ë³¼ë¥¨ 1.0 ê°•ì œ ì„¤ì •)
                const kneadSfx = document.getElementById('sfx-knead');
                if (kneadSfx) {
                    kneadSfx.volume = 1.0; // ë³¼ë¥¨ì„ ìµœëŒ€(1.0)ë¡œ ì„¤ì •
                    kneadSfx.currentTime = 0;
                    kneadSfx.play().catch(err => console.log(err));
                }

                doughScore++; dough.classList.remove('dough-squish'); void dough.offsetWidth; dough.classList.add('dough-squish');
                if (doughScore >= DOUGH_GOAL) { doughScore = DOUGH_GOAL; updateDoughUI(); completeDoughStage(); } else { updateDoughUI(); setNewDoughKey(); }
            } else if (keys.includes(e.code)) { dough.classList.remove('dough-shake'); void dough.offsetWidth; dough.classList.add('dough-shake'); }
        }
        function updateDoughUI() { document.getElementById('dough-progress').style.width = (doughScore/DOUGH_GOAL*100) + '%'; document.getElementById('dough-status-text').textContent = `ë°˜ì£½ ì™„ì„±ë„: ${Math.floor(doughScore/DOUGH_GOAL*100)}%`; }
        function completeDoughStage() {
            window.removeEventListener('keydown', handleDoughKey); document.getElementById('key-display').style.display = 'none';
            document.querySelector('.rhythm-container').innerHTML += '<h2 style="color:#FFD700; z-index:20;">ì™„ì„±!</h2>';
            setTimeout(() => { playInterlude(bridgeSauceData, () => { showStage('stage-sauce'); initStageSauce(); }); }, 1000);
        }

        // --- 1.8ë‹¨ê³„: í† ë§ˆí†  ë‹Œì ---
        let sauceScore = 0; const SAUCE_GOAL = 15; let sauceTimeLeft = 15; let tomatoes = []; let spawnIntervalId;

        function initSlashEffect() {
            const stage = document.getElementById('stage-sauce');
            if (stage.slashHandler) stage.removeEventListener('mousemove', stage.slashHandler);
            stage.slashHandler = function(e) {
                if (Math.random() > 0.4) return;
                const trail = document.createElement('div'); trail.className = 'slash-trail';
                trail.style.left = e.clientX + 'px'; trail.style.top = e.clientY + 'px';
                document.body.appendChild(trail);
                setTimeout(() => { if(trail.parentNode) trail.remove(); }, 300);
            };
            stage.addEventListener('mousemove', stage.slashHandler);
        }
        function initStageSauce() {
            sauceScore = 0; sauceTimeLeft = 15; tomatoes = [];
            document.getElementById('sauce-progress-fill').style.height = '0%';
            document.getElementById('sauce-score').textContent = 'Score: 0/' + SAUCE_GOAL;
            document.getElementById('sauce-game-area').innerHTML = '';
            initSlashEffect();
            sauceInterval = setInterval(() => {
                sauceTimeLeft -= 0.1; document.getElementById('sauce-timer').textContent = sauceTimeLeft.toFixed(2);
                if (sauceTimeLeft <= 0) { cleanupSauceStage(); if (sauceScore >= SAUCE_GOAL) successSauceStage(); else failSauceStage(); }
            }, 100);
            gameLoopId = requestAnimationFrame(tomatoGameLoop); spawnTomato();
        }
        function cleanupSauceStage() {
            clearInterval(sauceInterval); clearInterval(spawnIntervalId); cancelAnimationFrame(gameLoopId);
            const stage = document.getElementById('stage-sauce'); if (stage.slashHandler) stage.removeEventListener('mousemove', stage.slashHandler);
        }
        function spawnTomato() {
            if (sauceTimeLeft <= 0) return;
            const gameArea = document.getElementById('sauce-game-area');
            const tomato = document.createElement('div'); tomato.className = 'tomato';
            const fromLeft = Math.random() < 0.5;
            let startX, startY = window.innerHeight * (0.5 + Math.random() * 0.3), velocityX, velocityY = -(Math.random() * 4 + 10);
            if (fromLeft) { startX = -80; velocityX = Math.random() * 3 + 4; } else { startX = window.innerWidth + 80; velocityX = -(Math.random() * 3 + 4); }
            tomato.style.left = startX + 'px'; tomato.style.top = startY + 'px';
            gameArea.appendChild(tomato);
            const tObj = { el: tomato, x: startX, y: startY, vx: velocityX, vy: velocityY, r: 0, vr: (Math.random()-0.5)*6, sliced: false };
            tomatoes.push(tObj);
            tomato.onmouseenter = () => { if (!tObj.sliced) handleSlice(tObj); };
            spawnIntervalId = setTimeout(spawnTomato, Math.random() * 200 + 200); 
        }
        function handleSlice(t) {
            // [ì¶”ê°€ëœ ë¶€ë¶„] ë°°íŠ¸ ì†Œë¦¬ ì¬ìƒ
            const batSfx = document.getElementById('sfx-bat');
            if (batSfx) {
                batSfx.currentTime = 0;
                batSfx.play().catch(e => console.log(e));
            }

            t.sliced = true; sauceScore++; 
            const progress = (sauceScore / SAUCE_GOAL) * 100;
            document.getElementById('sauce-progress-fill').style.height = `${progress}%`;
            document.getElementById('sauce-score').textContent = 'Score: ' + sauceScore + '/' + SAUCE_GOAL;
            
            t.el.style.background = 'none'; t.el.style.boxShadow = 'none';
            t.el.innerHTML = '<div class="tomato-slice-left"></div><div class="tomato-slice-right"></div>';
            const splat = document.createElement('div'); splat.className = 'splat-effect';
            splat.style.left = t.x+45+'px'; splat.style.top = t.y+45+'px'; document.getElementById('sauce-game-area').appendChild(splat);
            setTimeout(() => splat.remove(), 500);
        }
        function tomatoGameLoop() {
            if (sauceTimeLeft <= 0 && sauceScore < SAUCE_GOAL) return;
            for (let i = tomatoes.length - 1; i >= 0; i--) {
                const t = tomatoes[i]; t.vy += 0.2; t.x += t.vx; t.y += t.vy; t.r += t.vr;
                t.el.style.left = t.x + 'px'; t.el.style.top = t.y + 'px';
                if (!t.sliced) t.el.style.transform = `rotate(${t.r}deg)`;
                if (t.y > window.innerHeight + 100) { if(t.el.parentNode) t.el.parentNode.removeChild(t.el); tomatoes.splice(i, 1); }
            }
            gameLoopId = requestAnimationFrame(tomatoGameLoop);
        }
        function successSauceStage() {
            document.getElementById('sauce-game-area').innerHTML = ''; const transitionEl = document.getElementById('pizza-transition'); transitionEl.classList.add('slide-in');
            setTimeout(() => { transitionEl.classList.remove('slide-in'); playInterlude(bridgeToppingData, () => { showStage('stage-topping'); initStageTopping(); }); }, 1200);
        }
        function failSauceStage() {
            document.getElementById('game-over').classList.add('active'); document.getElementById('fail-reason').innerText = `í† ë§ˆí†  ì†ŒìŠ¤ ë¶€ì¡±... (${sauceScore}/${SAUCE_GOAL})`;
            document.getElementById('btn-retry').onclick = () => { document.getElementById('game-over').classList.remove('active'); showStage('stage-sauce'); initStageSauce(); };
        }

        // --- 1.9ë‹¨ê³„: íŒŒì¸ì• í”Œ í† í•‘ ---
        let pineapplesPlaced = 0;
        function initStageTopping() {
            pineapplesPlaced = 0;
            const dock = document.getElementById('dock'); const newDock = dock.cloneNode(true); dock.parentNode.replaceChild(newDock, dock);
            document.querySelectorAll('.placed-pineapple').forEach(el => el.remove());
            document.querySelectorAll('.target-zone').forEach(t => { t.style.display = 'block'; t.innerHTML = ''; });
            
            document.querySelectorAll('.pineapple').forEach(p => {
                p.style.display = 'block'; p.style.opacity = '1';
                p.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text', e.target.id); setTimeout(() => p.style.opacity = '0.5', 0); });
                p.addEventListener('dragend', (e) => e.target.style.opacity = '1');
            });
            document.querySelectorAll('.target-zone').forEach(target => {
                target.addEventListener('dragover', (e) => e.preventDefault());
                target.addEventListener('drop', (e) => {
                    e.preventDefault(); const id = e.dataTransfer.getData('text'); const draggedEl = document.getElementById(id);
                    if (draggedEl) {
                        draggedEl.style.display = 'none'; const newP = document.createElement('div'); newP.className = 'placed-pineapple';
                        document.getElementById('topping-pizza-container').appendChild(newP);
                        const style = window.getComputedStyle(target); newP.style.top = style.top; newP.style.left = style.left;
                        target.style.display = 'none'; pineapplesPlaced++;
                        if (pineapplesPlaced === 5) setTimeout(completeToppingStage, 500);
                    }
                });
            });
        }
        function completeToppingStage() { playInterlude(bridgeOvenData, () => { showStage('stage-2'); initStage2(); }); }

        // --- 2ë‹¨ê³„: ì˜¤ë¸ ---
        let currentTemp = 0; const MAX_TEMP = 400; let decayRate = 0.3; let increaseAmount = 30;
        function initStage2() { 
            // [ì¶”ê°€ëœ ë¶€ë¶„] í™”ë¡œ ì†Œë¦¬ ì¬ìƒ
            const bonfireBgm = document.getElementById('bgm-bonfire');
            if (bonfireBgm) {
                bonfireBgm.volume = 0.5; // ì†Œë¦¬ í¬ê¸° ì¡°ì ˆ
                bonfireBgm.play().catch(e => console.log(e));
            }

            currentTemp = 0; updateOvenUI(); window.addEventListener('keyup', handleSpaceKey); ovenLoopId = requestAnimationFrame(ovenLoop); 
        }
        function handleSpaceKey(e) {
            if (e.code === 'Space') {
                currentTemp += increaseAmount; 
                const pizzaWrapper = document.getElementById('oven-pizza-wrapper');
                pizzaWrapper.classList.remove('shake-hard'); void pizzaWrapper.offsetWidth; pizzaWrapper.classList.add('shake-hard');
                if (currentTemp >= MAX_TEMP) { currentTemp = MAX_TEMP; updateOvenUI(); ovenClear(); return; }
                updateOvenUI();
            }
        }
        function ovenLoop() { if (currentTemp > 0) { currentTemp -= decayRate; if (currentTemp < 0) currentTemp = 0; } updateOvenUI(); if (currentTemp >= 400) { ovenClear(); return; } ovenLoopId = requestAnimationFrame(ovenLoop); }
        function updateOvenUI() { document.getElementById('temp-display').innerText = Math.floor(currentTemp); document.getElementById('temp-bar').style.width = (currentTemp/MAX_TEMP*100) + '%'; document.querySelector('.fire-overlay').style.opacity = currentTemp/400; }
        function ovenClear() { 
            // [ì¶”ê°€ëœ ë¶€ë¶„] í™”ë¡œ ì†Œë¦¬ ë©ˆì¶¤
            const bonfireBgm = document.getElementById('bgm-bonfire');
            if (bonfireBgm) {
                bonfireBgm.pause();
                bonfireBgm.currentTime = 0;
            }

            cancelAnimationFrame(ovenLoopId); window.removeEventListener('keyup', handleSpaceKey); playInterlude(bridgeDefenseData, () => { showStage('stage-3'); initStage3(); }); 
        }

        // --- 3ë‹¨ê³„: í”¼ì ìˆ˜í˜¸ (Delta Time + ë§ˆìš°ìŠ¤ ì‰´ë“œ) ---
        let enemies = [], spawnRate = 0.5, spawnTimer = 0, survivalTime = 15;
        const MAX_SURVIVAL_TIME = 15; let mouseX = 0, mouseY = 0;

        class MintChoco {
            constructor() {
                this.el = document.createElement('div'); this.el.className = 'mint-choco';
                document.body.appendChild(this.el);
                const edge = Math.floor(Math.random() * 4);
                if(edge===0){this.x=Math.random()*window.innerWidth;this.y=-300;}
                else if(edge===1){this.x=window.innerWidth+300;this.y=Math.random()*window.innerHeight;}
                else if(edge===2){this.x=Math.random()*window.innerWidth;this.y=window.innerHeight+300;}
                else{this.x=-300;this.y=Math.random()*window.innerHeight;}
                this.size = 180; 
                this.speed = 200 + Math.random() * 150; // ì´ˆë‹¹ í”½ì…€ ì†ë„ (DeltaTimeìš©)
                this.vx = 0; this.vy = 0; this.isRepelled = false;
                
                const pCx = window.innerWidth / 2; const pCy = window.innerHeight / 2;
                const myCx = this.x + this.size / 2; const myCy = this.y + this.size / 2;
                const angle = Math.atan2(pCy - myCy, pCx - myCx);
                this.vx = Math.cos(angle) * this.speed;
                this.vy = Math.sin(angle) * this.speed;
            }

            update(dt) {
                const pCx = window.innerWidth / 2; const pCy = window.innerHeight / 2;
                const myCx = this.x + this.size / 2; const myCy = this.y + this.size / 2;
                const distToPizza = Math.sqrt((pCx-myCx)**2 + (pCy-myCy)**2);
                const distToMouse = Math.sqrt((myCx-mouseX)**2 + (myCy-mouseY)**2);
                const shieldRadius = (this.size / 2) + 50; // ì‰´ë“œ ë²”ìœ„

                if (distToMouse < shieldRadius && !this.isRepelled) {
                    this.isRepelled = true;
                    this.vx = ((myCx - mouseX) / distToMouse) * 1000;
                    this.vy = ((myCy - mouseY) / distToMouse) * 1000;
                }

                this.x += this.vx * dt;
                this.y += this.vy * dt;
                this.el.style.left = this.x + 'px'; this.el.style.top = this.y + 'px';

                if (!this.isRepelled && distToPizza < 100) return 'HIT_PIZZA';
                if (this.x < -400 || this.x > window.innerWidth + 400 || this.y < -400 || this.y > window.innerHeight + 400) return 'OUT';
                return 'ALIVE';
            }
        }

        function initStage3() {
            enemies = []; spawnRate = 0.5; spawnTimer = 0; survivalTime = 15;
            document.getElementById('timer').style.display = 'block';
            document.getElementById('shield').style.display = 'block';
            document.getElementById('time-bar-container').style.display = 'block';
            document.getElementById('time-bar').style.width = '100%';
            document.body.style.cursor = 'none';
            
            document.addEventListener('mousemove', handleShieldMove);
            
            document.querySelectorAll('.mint-choco').forEach(e => e.remove());

            lastTime = performance.now();
            gameLoopId = requestAnimationFrame(defenseLoop);
        }

        function handleShieldMove(e) { mouseX = e.clientX; mouseY = e.clientY; document.getElementById('shield').style.left = mouseX + 'px'; document.getElementById('shield').style.top = mouseY + 'px'; }

        function defenseLoop(timestamp) {
            const dt = (timestamp - lastTime) / 1000;
            lastTime = timestamp;
            if (dt > 0.1) { requestAnimationFrame(defenseLoop); return; } // ë ‰ ë°©ì§€

            survivalTime -= dt;
            if(survivalTime < 0) survivalTime = 0;
            document.getElementById('timer').innerText = survivalTime.toFixed(2);
            document.getElementById('time-bar').style.width = (survivalTime / MAX_SURVIVAL_TIME) * 100 + '%';

            if (survivalTime <= 0) { gameWinStage3(); return; }

            spawnTimer += dt;
            if (spawnTimer > spawnRate) {
                enemies.push(new MintChoco());
                spawnTimer = 0;
                if (spawnRate > 0.1) spawnRate -= 0.01; // ì ì  ë¹¨ë¼ì§
            }

            for (let i = enemies.length - 1; i >= 0; i--) {
                const status = enemies[i].update(dt);
                if (status === 'HIT_PIZZA') { endGame(); return; }
                else if (status === 'OUT') { enemies[i].el.remove(); enemies.splice(i, 1); }
            }
            gameLoopId = requestAnimationFrame(defenseLoop);
        }

        function endGame() {
            cancelAnimationFrame(gameLoopId); document.removeEventListener('mousemove', handleShieldMove);
            document.body.style.cursor = 'default';
            document.getElementById('game-over').classList.add('active');
            document.getElementById('fail-reason').innerText = "ë¯¼íŠ¸ì´ˆì½”ì— ì˜¤ì—¼ë˜ì—ˆìŠµë‹ˆë‹¤.";
            document.getElementById('btn-retry').onclick = () => {
                enemies.forEach(e => e.el.remove());
                document.getElementById('game-over').classList.remove('active');
                initStage3(); 
            };
        }

        function gameWinStage3() {
            cancelAnimationFrame(gameLoopId); document.removeEventListener('mousemove', handleShieldMove);
            enemies.forEach(e => e.el.remove()); 
            document.body.style.cursor = 'default';
            document.getElementById('shield').style.display = 'none';
            document.getElementById('time-bar-container').style.display = 'none';
            playInterlude(bridgeRitualData, () => { showStage('stage-ritual'); initRitualStage(); });
        }

        // 4ë‹¨ê³„: ì„±ì°¬ì‹
        function initRitualStage() {
            const pizzaEl = document.getElementById('final-pizza');
            pizzaEl.onclick = function() {
                pizzaEl.onclick = null;
                pizzaEl.classList.add('bitten');
                setTimeout(() => {
                    const flash = document.getElementById('white-flash');
                    flash.classList.add('flash-active');
                    setTimeout(() => {
                        showVictoryScreen();
                        setTimeout(() => { flash.style.transition = 'opacity 1s ease-out'; flash.classList.remove('flash-active'); }, 500);
                    }, 2000);
                }, 800);
            };
        }

        // ë°˜ì§ì´ ìƒì„± í•¨ìˆ˜
        function createSparkles() {
            const container = document.getElementById('victory-screen');
            for (let i = 0; i < 30; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                const angle = Math.random() * Math.PI * 2;
                const radius = 300 + Math.random() * 500;
                const x = Math.cos(angle) * radius + window.innerWidth / 2;
                const y = Math.sin(angle) * radius + window.innerHeight / 2;
                sparkle.style.left = x + 'px'; sparkle.style.top = y + 'px';
                sparkle.style.animationDelay = Math.random() * 2 + 's';
                container.appendChild(sparkle);
            }
        }

        function showVictoryScreen() {
            showStage('victory-screen'); 
            document.getElementById('victory-screen').classList.add('active');
            
            createSparkles();

            // [ìˆ˜ì •] ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì‹œ ì˜ˆìˆ˜ë‹˜ ì´ë¯¸ì§€(tomato_sauce.jpg) ë‹¤ìš´ë¡œë“œ
            document.getElementById('btn-download').onclick = () => {
                const link = document.createElement('a'); 
                link.href = 'pizzathegod.png'; // ì˜ˆìˆ˜ë‹˜ ì´ë¯¸ì§€ë¡œ ì„¤ì •ë¨
                link.download = 'sacred_jesus.jpg'; // ì €ì¥ë  íŒŒì¼ëª…
                document.body.appendChild(link); 
                link.click(); 
                document.body.removeChild(link); 
                alert("ì„±ìŠ¤ëŸ¬ìš´ í”¼ìê°€ ê°•ë¦¼í–ˆìŠµë‹ˆë‹¤.");
            };
            document.getElementById('btn-share').onclick = () => { navigator.clipboard.writeText(window.location.href).then(() => alert("ë§í¬ ë³µì‚¬ ì™„ë£Œ.")).catch(() => prompt("ë§í¬ ë³µì‚¬:", window.location.href)); };
            document.getElementById('btn-restart-game').onclick = () => location.reload();
            
            const titles = ["ê³¼ì¦™ì˜ ì‚¬ë„", "ì‹ ì„±í•œ ì¡°ê°", "ì˜¤ë¸ì˜ íŒŒìˆ˜ê¾¼", "í™©ê¸ˆ í˜€ì˜ ì‹œì¢…"];
            document.getElementById('new-cult-name').textContent = `${titles[Math.floor(Math.random()*titles.length)]} ${Math.floor(Math.random()*900)+100}í˜¸`;
        }
    </script>
</body>
</html>